# Virtual memory
## About
This page is to document virtual memory in amd64, specifically just notes I take from the Intel SDM about paging.
## Note on paging with Limine bootloader
Limine already sets up paging for us, mapping the kernel at a higher half, and mapping physical RAM to a specific virtual address, with it being Limine's HHDM offset. Therefore, we don't actually need to enable paging, as it's already enabled.
## What is paging?
Paging is a mechanism that involves amd64's MMU. It allows us to have a virtual address space, where we can map RAM (memory) and other types of memory such as storage devices & other I/O devices to the virtual address space.
According to the Intel SDM, in amd64 CPUs, there are four different modes of paging.
## How is paging controlled?
When running in long mode, the CR3 register points to the base address of the PML4 structure, when 5-level paging is disabled. If 5-level paging is enabled, then the CR3 register is expanded to 64 bits. This would allow the PML4 or PML5 structure to be located anywhere in the 52-bit physical address space in RAM.
5-level paging is disabled when LA57 bit of CR4 is set to 0. When it is set to 1, 5-level-paging is enabled. If 5-level paging is enabled, CR3 register will point to the PML5 structure, and PML4 structure vice versa.
In summary, to flush a PML structure, we must set CR3 register to the address of the structure.
## What value should pages be aligned as?
When a page is aligned, it's last few bits are set to zero. For example a 4KiB page, which is 4096 bytes, would have it's last 12 bits set to zero (2^12 = 4096). 2MiB pages have their last 20 bits set to zero, 4MiB pages have their last 21 bits set to 0, and 1GiB pages have their last 29 bits set to 0.
For table entries, the last bit indicates whether the page is actually being used or not. The second last bit, determines a page's read/write permissions, the third last bit determines if the page can be accessed by region 0, 1, 2, or 3. If set to 0, access is restricted to ring 0, 1 or 2. If set to 1, rings 0, 1, 2, and 3 can access it. The fourth last bit represents page writethrough. If set to 0, then the table has a writeback caching policy. When set to 1, it has a writethrough caching policy. The last fifth bit represents cache disable. If set to 0, the table is cacheable, but if set to 1, it isn't cacheable. The sixth last bit represents whether the page has been accessed or not. The processor sets it to 1 when it uses the page, and the kernel must set it back to zero if it wants to keep track of the usage of a page. The last seventh bit is set to 1 by the processor once it's used for the first time. Like the sixth last bit, it must be cleared by the kernel or else it won't ever be cleared. This is only for the lowest level of page translation hierarchy.